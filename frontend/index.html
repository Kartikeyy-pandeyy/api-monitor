<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Health Monitor | Real-time Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1089/1089030.png" type="image/png" />
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      --danger-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      --dark-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
    }

    * {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000000;
      color: #ffffff;
      min-height: 100vh;
      background-image:
        radial-gradient(at 20% 50%, rgba(24, 24, 27, 0.8) 0px, transparent 50%),
        radial-gradient(at 80% 20%, rgba(39, 39, 42, 0.8) 0px, transparent 50%),
        radial-gradient(at 40% 40%, rgba(24, 24, 27, 0.8) 0px, transparent 50%);
    }

    .glass-morphism {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.02);
    }

    .shimmer {
      background: linear-gradient(90deg, #111111 25%, #222222 50%, #111111 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .api-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(0);
    }

    .api-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .status-indicator {
      position: relative;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-up {
      background: linear-gradient(45deg, #10b981, #34d399);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    .status-down {
      background: linear-gradient(45deg, #ef4444, #f87171);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }

    .status-warning {
      background: linear-gradient(45deg, #f59e0b, #fbbf24);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .latency-bar {
      height: 8px;
      border-radius: 4px;
      background: rgba(229, 231, 235, 0.3);
      overflow: hidden;
      position: relative;
    }

    .latency-progress {
      height: 100%;
      border-radius: 4px;
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .latency-progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: latencyShine 2s infinite;
    }

    @keyframes latencyShine {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .metric-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .history-timeline {
      position: relative;
      padding-left: 1rem;
    }

    .history-timeline::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, #10b981, #ef4444);
    }

    .history-item {
      position: relative;
      padding-left: 1rem;
      margin-bottom: 0.5rem;
    }

    .history-item::before {
      content: '';
      position: absolute;
      left: -5px;
      top: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 2px solid white;
    }

    .history-item.up::before { background: #10b981; }
    .history-item.down::before { background: #ef4444; }
    .history-item.moderate::before { background: #f59e0b; }

    .floating-stats {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      pointer-events: none;
    }

    .search-container {
      position: relative;
    }

    .search-container input {
      padding-left: 2.5rem;
      transition: all 0.3s ease;
    }

    .search-container input:focus {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      border-color: #3b82f6;
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }

    .filter-button {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .filter-button.active {
      background: #3b82f6;
      color: white;
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { background: #10b981; }
    .notification.error { background: #ef4444; }

    .loading-dots {
      display: inline-block;
    }

    .loading-dots::after {
      content: '';
      animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    .critical-glow {
      animation: criticalPulse 2s infinite;
    }

    @keyframes criticalPulse {
      0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.3); }
      50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.8), 0 0 30px rgba(239, 68, 68, 0.4); }
    }

    .uptime-chart {
      height: 40px;
      display: flex;
      align-items: end;
      gap: 2px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .uptime-bar {
      flex: 1;
      min-height: 4px;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    .uptime-bar.up { background: #10b981; }
    .uptime-bar.down { background: #ef4444; }
    .uptime-bar.moderate { background: #f59e0b; }

    .dark .uptime-chart {
      background: rgba(255, 255, 255, 0.05);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
      .floating-stats {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 1rem;
      }

      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
      }

      .metric-card {
        padding: 1rem;
      }

      .api-card {
        padding: 1rem;
      }

      .api-card h3 {
        font-size: 1.125rem;
      }

      .api-card .grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .history-container {
        display: none !important;
      }

      .toggle-history {
        display: none !important;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }

      .metric-card {
        padding: 0.75rem;
      }

      .metric-card p:first-child {
        font-size: 1.25rem;
      }

      .api-card {
        padding: 0.75rem;
        border-radius: 1rem;
      }

      .container {
        padding: 0.75rem;
      }

      .glow-text {
        font-size: 1.875rem !important;
      }

      .scroll-indicator {
        height: 2px;
      }
    }

    .mobile-card {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      padding: 0.75rem;
    }

    /* Performance optimizations */
    .filter-button {
      will-change: transform, background-color;
    }

    .filter-button:hover {
      transform: translateY(-1px);
    }

    .count-badge {
      transition: background-color 0.3s ease;
      will-change: contents;
    }

    /* Full screen modal optimizations */
    #location-test-modal .glass-morphism {
      border-radius: 0;
      border: none;
    }

    /* Scrollbar styling for better UX */
    .overflow-auto::-webkit-scrollbar {
      width: 8px;
    }

    .overflow-auto::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    .overflow-auto::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    .overflow-auto::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Responsive table */
    @media (max-width: 768px) {
      .min-w-\[600px\] { min-width: 400px; }
    }

    .theme-transition {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .scroll-indicator {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
      background-size: 200% 100%;
      animation: gradientShift 3s ease infinite;
      z-index: 1000;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 0%; }
      50% { background-position: 100% 0%; }
    }

    .glow-text {
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 40px rgba(139, 92, 246, 0.6), 0 0 60px rgba(236, 72, 153, 0.4);
      background-size: 200% auto;
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      0% {
        background-position: 0% center;
        text-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 40px rgba(139, 92, 246, 0.6), 0 0 60px rgba(236, 72, 153, 0.4);
      }
      100% {
        background-position: 200% center;
        text-shadow: 0 0 25px rgba(139, 92, 246, 1), 0 0 50px rgba(236, 72, 153, 0.8), 0 0 75px rgba(59, 130, 246, 0.6);
      }
    }

    .status-badge {
      position: relative;
      overflow: hidden;
    }

    .status-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .status-badge:hover::before {
      left: 100%;
    }

    .metric-card {
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4, #3b82f6);
      background-size: 400% 400%;
      animation: borderGlow 4s ease infinite;
      border-radius: inherit;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .metric-card:hover::before {
      opacity: 1;
    }

    @keyframes borderGlow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
  </style>
</head>
<body class="theme-transition">
  <div class="scroll-indicator" id="scrollIndicator"></div>

  <div id="notification" class="notification"></div>

  <main class="container mx-auto p-2 sm:p-4 lg:p-6 max-w-7xl">
    <!-- Header Section -->
    <header class="glass-morphism rounded-xl sm:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-8 relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10"></div>
      <div class="relative z-10">
        <div class="flex flex-col lg:flex-row justify-between items-center">
          <div class="text-center lg:text-left mb-4 sm:mb-6 lg:mb-0 w-full lg:w-auto">
            <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 via-pink-400 to-blue-400 bg-clip-text text-transparent mb-2 glow-text">
              üîç API Health Monitor
            </h1>
            <p class="text-gray-100 text-sm sm:text-base lg:text-lg">Real-time monitoring dashboard for all your services</p>
          </div>

          <div class="flex flex-col sm:flex-row flex-wrap items-center gap-2 sm:gap-4 w-full lg:w-auto">
            <div class="glass-morphism rounded-lg px-3 sm:px-4 py-2 w-full sm:w-auto">
              <p id="last-updated" class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 flex items-center justify-center sm:justify-start">
                <i class="fas fa-clock mr-2"></i>
                <span class="loading-dots">Loading</span>
              </p>
            </div>

            <button id="test-from-location-btn" class="glass-morphism hover:bg-purple-500 text-purple-400 hover:text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl transition-all duration-300 flex items-center gap-2 font-medium text-xs sm:text-sm w-full sm:w-auto justify-center">
              <i class="fas fa-map-marker-alt"></i>
              <span class="hidden sm:inline">Test from My Location</span>
              <span class="sm:hidden">Location Test</span>
            </button>

            <button id="refresh-btn" class="glass-morphism hover:bg-blue-500 text-blue-400 hover:text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl transition-all duration-300 flex items-center gap-2 font-medium text-xs sm:text-sm w-full sm:w-auto justify-center">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="metric-card rounded-xl p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-green-500" id="total-up">0</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">Services Up</p>
          </div>
          <div class="status-indicator status-up"></div>
        </div>
      </div>

      <div class="metric-card rounded-xl p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-red-500" id="total-down">0</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">Services Down</p>
          </div>
          <div class="status-indicator status-down"></div>
        </div>
      </div>

      <div class="metric-card rounded-xl p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-blue-500" id="avg-latency">0ms</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">Avg Latency</p>
          </div>
          <i class="fas fa-bolt text-2xl text-blue-500"></i>
        </div>
      </div>

      <div class="metric-card rounded-xl p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-purple-500" id="uptime-percent">0%</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">Overall Uptime</p>
          </div>
          <i class="fas fa-chart-line text-2xl text-purple-500"></i>
        </div>
      </div>
    </div>

    <!-- Controls Section -->
    <div class="glass-morphism rounded-xl sm:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-8">
      <div class="flex flex-col gap-4">
        <div class="search-container w-full">
          <input
            id="search-input"
            type="text"
            placeholder="Search APIs..."
            class="w-full glass-morphism rounded-lg sm:rounded-xl py-2 sm:py-3 text-gray-200 placeholder-gray-400 focus:outline-none text-sm sm:text-base"
          />
          <i class="fas fa-search search-icon"></i>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-stretch sm:items-center">
          <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-2 flex-1">
            <button class="filter-button active glass-morphism px-2 sm:px-3 py-2 rounded-lg text-xs sm:text-sm font-medium flex items-center justify-center" data-filter="all">
              <span class="mr-1">All</span>
              <span class="count-badge bg-blue-600 text-white px-1.5 py-0.5 rounded-full text-xs" data-count="all">0</span>
            </button>
            <button class="filter-button glass-morphism px-2 sm:px-3 py-2 rounded-lg text-xs sm:text-sm font-medium flex items-center justify-center" data-filter="up">
              <i class="fas fa-check-circle text-green-500 mr-1"></i>
              <span class="hidden sm:inline mr-1">UP</span><span class="sm:hidden mr-1">‚úì</span>
              <span class="count-badge bg-green-600 text-white px-1.5 py-0.5 rounded-full text-xs" data-count="up">0</span>
            </button>
            <button class="filter-button glass-morphism px-2 sm:px-3 py-2 rounded-lg text-xs sm:text-sm font-medium flex items-center justify-center" data-filter="down">
              <i class="fas fa-times-circle text-red-500 mr-1"></i>
              <span class="hidden sm:inline mr-1">DOWN</span><span class="sm:hidden mr-1">‚úó</span>
              <span class="count-badge bg-red-600 text-white px-1.5 py-0.5 rounded-full text-xs" data-count="down">0</span>
            </button>
            <button class="filter-button glass-morphism px-2 sm:px-3 py-2 rounded-lg text-xs sm:text-sm font-medium flex items-center justify-center" data-filter="critical">
              <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>
              <span class="hidden sm:inline mr-1">Critical</span><span class="sm:hidden mr-1">!</span>
              <span class="count-badge bg-yellow-600 text-white px-1.5 py-0.5 rounded-full text-xs" data-count="critical">0</span>
            </button>
          </div>

          <select id="sort" class="glass-morphism rounded-lg px-3 py-2 text-gray-200 focus:outline-none text-xs sm:text-sm w-full sm:w-auto">
            <option value="name">Name (A-Z)</option>
            <option value="latency-high">Latency (High to Low)</option>
            <option value="latency-low">Latency (Low to High)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- API Cards Grid -->
    <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-6 mb-4 sm:mb-8">
      <!-- Cards will be rendered here -->
    </div>

    <!-- Footer -->
    <footer class="glass-morphism rounded-xl sm:rounded-2xl p-4 sm:p-6 text-center">
      <p class="text-gray-400 text-xs sm:text-sm">
        <i class="fas fa-heart text-red-500 mx-1"></i>
        <span class="hidden sm:inline">Made with love for monitoring APIs ‚Ä¢ </span>
        <span class="sm:hidden">API Monitor ‚Ä¢ </span>
        Last scan: <span id="footer-time">--</span>
      </p>
    </footer>
  </main>

  <!-- Test from Location Modal -->
  <div id="location-test-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm z-50 hidden">
    <div class="h-full w-full flex flex-col">
      <div class="glass-morphism h-full w-full flex flex-col shadow-2xl">
        <!-- Modal Header - Fixed at top -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 sm:p-4 md:p-6 border-b border-gray-700 bg-black/95 backdrop-blur-lg z-30 flex-shrink-0">
          <div class="mb-3 sm:mb-0">
            <h2 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-white mb-1 sm:mb-2">Test APIs from Your Location</h2>
            <p class="text-gray-300 text-xs sm:text-sm md:text-base">Compare server monitoring results with direct tests from your browser</p>
          </div>
          <button id="close-modal" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-gray-800 rounded-lg self-end sm:self-auto">
            <i class="fas fa-times text-lg sm:text-xl md:text-2xl"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="flex flex-col flex-1 min-h-0">
          <!-- Test Controls - Fixed below header -->
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 md:gap-4 p-3 sm:p-4 md:p-6 bg-gray-900/50 backdrop-blur-sm border-b border-gray-700 flex-shrink-0">
            <button id="start-location-test" class="bg-purple-500 hover:bg-purple-600 text-white px-3 sm:px-4 md:px-6 lg:px-8 py-2 sm:py-2.5 md:py-3 rounded-lg transition-all duration-300 flex items-center gap-2 font-medium text-xs sm:text-sm md:text-base w-full sm:w-auto justify-center">
              <i class="fas fa-play text-xs sm:text-sm"></i>
              <span class="hidden xs:inline">Start Location Test</span>
              <span class="xs:hidden">Start Test</span>
            </button>
            <button id="stop-location-test" class="bg-red-500 hover:bg-red-600 text-white px-3 sm:px-4 md:px-6 lg:px-8 py-2 sm:py-2.5 md:py-3 rounded-lg transition-all duration-300 flex items-center gap-2 font-medium text-xs sm:text-sm md:text-base w-full sm:w-auto justify-center hidden">
              <i class="fas fa-stop text-xs sm:text-sm"></i>
              <span class="hidden xs:inline">Stop Test</span>
              <span class="xs:hidden">Stop</span>
            </button>
            <div class="text-gray-300 text-xs sm:text-sm md:text-base">
              <span id="test-progress">Ready to test <span id="total-apis-count">0</span> APIs</span>
            </div>
          </div>

          <!-- Results Table Container - Scrollable content -->
          <div class="flex-1 overflow-auto min-h-0 p-3 sm:p-4 md:p-6">
            <div class="glass-morphism rounded-lg overflow-hidden">
              <!-- Mobile Card View -->
              <div class="block md:hidden" id="mobile-results">
                <div id="mobile-test-results" class="space-y-3">
                  <!-- Mobile cards will be populated here -->
                </div>
              </div>

              <!-- Tablet/Desktop Table View -->
              <div class="hidden md:block">
                <div class="overflow-x-auto">
                  <table class="w-full text-xs sm:text-sm lg:text-base min-w-[600px]">
                    <thead class="bg-gray-900 sticky top-0 z-10">
                      <tr>
                        <th class="px-2 sm:px-3 lg:px-4 py-2 sm:py-3 text-left font-semibold text-gray-200 w-1/5">API Name</th>
                        <th class="px-2 sm:px-3 lg:px-4 py-2 sm:py-3 text-left font-semibold text-gray-200 w-1/5">Server Result</th>
                        <th class="px-2 sm:px-3 lg:px-4 py-2 sm:py-3 text-left font-semibold text-gray-200 w-1/5">Your Location Result</th>
                        <th class="px-2 sm:px-3 lg:px-4 py-2 sm:py-3 text-left font-semibold text-gray-200 w-1/5 hidden lg:table-cell">Test Method</th>
                        <th class="px-2 sm:px-3 lg:px-4 py-2 sm:py-3 text-left font-semibold text-gray-200 w-1/5 hidden xl:table-cell">Latency Diff</th>
                      </tr>
                    </thead>
                    <tbody id="location-test-results">
                      <!-- Results will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="api-card-template">
    <div class="api-card glass-morphism rounded-2xl p-6 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-500/10 to-purple-500/10 rounded-bl-full"></div>

      <div class="relative z-10">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1 min-w-0">
            <h3 class="text-xl font-bold text-gray-200 truncate mb-1"></h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 truncate api-url"></p>
          </div>
          <div class="flex items-center gap-2 ml-4">
            <div class="status-indicator"></div>
            <span class="status-badge px-3 py-1 rounded-full text-xs font-bold"></span>
            <span class="critical-tag hidden bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">CRITICAL</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center mr-3">
              <i class="fas fa-globe text-blue-500 text-sm"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Status</p>
              <p class="text-sm font-bold status-text"></p>
            </div>
          </div>

          <div class="flex items-center">
            <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center mr-3">
              <i class="fas fa-code text-green-500 text-sm"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">HTTP Code</p>
              <p class="text-sm font-bold code-text"></p>
            </div>
          </div>

          <div class="flex items-center">
            <div class="w-8 h-8 rounded-lg bg-yellow-500/10 flex items-center justify-center mr-3">
              <i class="fas fa-bolt text-yellow-500 text-sm"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Latency</p>
              <p class="text-sm font-bold latency-text"></p>
            </div>
          </div>

          <div class="flex items-center">
            <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center mr-3">
              <i class="fas fa-clock text-purple-500 text-sm"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Last Check</p>
              <p class="text-sm font-bold time-text"></p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <div class="flex justify-between text-xs text-gray-400 mb-2">
            <span>Response Time</span>
            <span class="latency-category"></span>
          </div>
          <div class="latency-bar">
            <div class="latency-progress"></div>
          </div>
        </div>

        <div class="uptime-section mb-4">
          <div class="flex justify-between text-xs text-gray-400 mb-2">
            <span>Recent History (24h)</span>
            <span class="uptime-percentage">--</span>
          </div>
          <div class="uptime-chart"></div>
        </div>

        <div class="history-container hidden">
          <p class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-3 uppercase tracking-wide">Recent Activity</p>
          <div class="history-timeline"></div>
        </div>

        <button class="toggle-history w-full mt-4 text-sm text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 transition-colors flex items-center justify-center gap-2">
          <i class="fas fa-chevron-down"></i>
          <span>Show History</span>
        </button>
      </div>
    </div>
  </template>

  <template id="loading-template">
    <div class="glass-morphism rounded-2xl p-6 shimmer">
      <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
          <div class="h-6 bg-gray-300 dark:bg-gray-600 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-1/2"></div>
        </div>
        <div class="w-12 h-6 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="h-12 bg-gray-300 dark:bg-gray-600 rounded"></div>
        <div class="h-12 bg-gray-300 dark:bg-gray-600 rounded"></div>
        <div class="h-12 bg-gray-300 dark:bg-gray-600 rounded"></div>
        <div class="h-12 bg-gray-300 dark:bg-gray-600 rounded"></div>
      </div>

      <div class="h-2 bg-gray-300 dark:bg-gray-600 rounded-full mb-4"></div>
      <div class="h-10 bg-gray-300 dark:bg-gray-600 rounded mb-4"></div>
      <div class="h-8 bg-gray-300 dark:bg-gray-600 rounded"></div>
    </div>
  </template>

  <script>
    class APIMonitor {
      constructor() {
        this.apis = [];
        this.history = [];
        this.currentFilter = 'all';
        this.currentSort = 'name';
        this.searchTerm = '';
        this.refreshInterval = null;

        this.init();
      }

      init() {
        this.bindEvents();
        this.loadStatus();
        this.startAutoRefresh();
        this.updateScrollIndicator();
      }

      bindEvents() {
        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', () => this.loadStatus(true));

        // Filter buttons
        document.querySelectorAll('.filter-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            this.currentFilter = e.target.dataset.filter;
            this.renderAPIs();
          });
        });

        // Sort dropdown
        document.getElementById('sort').addEventListener('change', (e) => {
          this.currentSort = e.target.value;
          this.renderAPIs();
        });

        // Search input
        document.getElementById('search-input').addEventListener('input', (e) => {
          this.searchTerm = e.target.value.toLowerCase();
          this.renderAPIs();
        });


        // Scroll indicator
        window.addEventListener('scroll', this.updateScrollIndicator);

        // Test from location modal
        document.getElementById('test-from-location-btn').addEventListener('click', () => this.openLocationTestModal());
        document.getElementById('close-modal').addEventListener('click', () => this.closeLocationTestModal());
        document.getElementById('start-location-test').addEventListener('click', () => this.startLocationTest());
        document.getElementById('stop-location-test').addEventListener('click', () => this.stopLocationTest());

        // Close modal on backdrop click
        document.getElementById('location-test-modal').addEventListener('click', (e) => {
          if (e.target.id === 'location-test-modal') {
            this.closeLocationTestModal();
          }
        });
      }

      startAutoRefresh() {
        this.stopAutoRefresh();
        this.refreshInterval = setInterval(() => {
          // Only refresh if page is visible
          if (!document.hidden) {
            this.loadStatus();
          }
        }, 5000);
      }

      stopAutoRefresh() {
        if (this.refreshInterval) {
          clearInterval(this.refreshInterval);
          this.refreshInterval = null;
        }
      }

      updateScrollIndicator() {
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        document.getElementById('scrollIndicator').style.width = scrollPercent + '%';
      }

      showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');

        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }


      async loadStatus(showNotification = false) {
        const refreshBtn = document.getElementById('refresh-btn');
        const icon = refreshBtn.querySelector('i');
        icon.style.animation = 'spin 1s linear infinite';

        if (showNotification) {
          this.showLoadingState();
        }

        try {
          const [statusRes, historyRes] = await Promise.all([
            fetch('https://api-monitor-data-bu.s3.us-east-1.amazonaws.com/frontend/status.json'),
            fetch('https://api-monitor-data-bu.s3.us-east-1.amazonaws.com/frontend/history.json')
          ]);

          if (!statusRes.ok) throw new Error('Failed to fetch status');

          this.apis = await statusRes.json();
          this.history = historyRes.ok ? await historyRes.json() : [];

          this.renderAPIs();
          this.updateStats();
          this.updateTimestamp();

          if (showNotification) {
            this.showNotification('Data refreshed successfully!', 'success');
          }

        } catch (error) {
          console.error('Error loading status:', error);
          if (showNotification) {
            this.showError();
          }
          this.showNotification('Failed to load data', 'error');
        } finally {
          icon.style.animation = '';
        }
      }

      showLoadingState() {
        const container = document.getElementById('dashboard');
        container.innerHTML = '';

        for (let i = 0; i < 6; i++) {
          const loadingCard = document.getElementById('loading-template').content.cloneNode(true);
          container.appendChild(loadingCard);
        }
      }

      showError() {
        const container = document.getElementById('dashboard');
        container.innerHTML = `
          <div class="col-span-full glass-morphism rounded-2xl p-12 text-center">
            <div class="mb-6">
              <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
              <h2 class="text-2xl font-bold text-gray-200 mb-2">Data Not Available</h2>
              <p class="text-gray-400">Unable to load API status. Please try again later.</p>
            </div>
            <button onclick="window.apiMonitor.loadStatus()" class="glass-morphism hover:bg-blue-500 text-blue-600 hover:text-white px-6 py-3 rounded-xl transition-all duration-300">
              <i class="fas fa-retry mr-2"></i>Retry
            </button>
          </div>
        `;
      }

      updateStats() {
        const upCount = this.apis.filter(api => api.status === 'UP').length;
        const downCount = this.apis.filter(api => api.status === 'DOWN').length;
        const criticalCount = this.apis.filter(api => api.critical).length;

        // Calculate average latency only from valid positive values
        const validLatencies = this.apis
          .map(api => api.latency && api.latency > 0 ? Math.max(0, api.latency) : 0)
          .filter(latency => latency > 0);

        const avgLatency = validLatencies.length
          ? Math.round(validLatencies.reduce((sum, latency) => sum + latency, 0) / validLatencies.length)
          : 0;

        const uptime = this.apis.length ? Math.round((upCount / this.apis.length) * 100) : 0;

        document.getElementById('total-up').textContent = upCount;
        document.getElementById('total-down').textContent = downCount;
        document.getElementById('avg-latency').textContent = avgLatency + 'ms';
        document.getElementById('uptime-percent').textContent = uptime + '%';

        // Update filter counts using data attributes
        const counts = { all: this.apis.length, up: upCount, down: downCount, critical: criticalCount };
        document.querySelectorAll('[data-count]').forEach(el => {
          el.textContent = counts[el.dataset.count] || '0';
        });
      }

      updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        document.getElementById('last-updated').innerHTML = `
          <i class="fas fa-clock mr-2"></i>
          Last updated: ${timeString}
        `;
        document.getElementById('footer-time').textContent = timeString;
      }

      filterAPIs() {
        return this.apis.filter(api => {
          // Filter by category
          let matchesFilter = true;
          if (this.currentFilter === 'up') matchesFilter = api.status === 'UP';
          else if (this.currentFilter === 'down') matchesFilter = api.status === 'DOWN';
          else if (this.currentFilter === 'critical') matchesFilter = api.critical;

          // Filter by search term
          const matchesSearch = this.searchTerm === '' ||
            api.name.toLowerCase().includes(this.searchTerm) ||
            api.url.toLowerCase().includes(this.searchTerm);

          return matchesFilter && matchesSearch;
        });
      }

      sortAPIs(apis) {
        return apis.sort((a, b) => {
          switch (this.currentSort) {
            case 'name':
              return a.name.localeCompare(b.name);
            case 'latency-high':
              const aLatencyHigh = Math.max(0, a.latency || 0);
              const bLatencyHigh = Math.max(0, b.latency || 0);
              return bLatencyHigh - aLatencyHigh;
            case 'latency-low':
              const aLatencyLow = Math.max(0, a.latency || 0);
              const bLatencyLow = Math.max(0, b.latency || 0);
              return aLatencyLow - bLatencyLow;
            default:
              return 0;
          }
        });
      }

      calculateUptime(apiName) {
        const apiHistory = this.history.filter(item => item.name === apiName).slice(-24);
        if (apiHistory.length === 0) return 0;
        const upCount = apiHistory.filter(item => item.status === 'UP').length;
        return Math.round((upCount / apiHistory.length) * 100);
      }

      getLatencyCategory(latency) {
        // Ensure latency is positive and valid
        const validLatency = latency && latency > 0 ? Math.max(0, latency) : null;

        if (!validLatency) return { category: 'Unknown', class: 'status-warning', color: '#6b7280' };
        if (validLatency <= 300) return { category: 'Excellent', class: 'status-up', color: '#10b981' };
        if (validLatency <= 1000) return { category: 'Good', class: 'status-warning', color: '#f59e0b' };
        return { category: 'Slow', class: 'status-down', color: '#ef4444' };
      }

      renderAPIs() {
        const container = document.getElementById('dashboard');
        const filteredAPIs = this.filterAPIs();
        const sortedAPIs = this.sortAPIs(filteredAPIs);

        container.innerHTML = '';

        if (sortedAPIs.length === 0) {
          container.innerHTML = `
            <div class="col-span-full glass-morphism rounded-2xl p-12 text-center">
              <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-300">No APIs Found</h3>
              <p class="text-gray-500 dark:text-gray-400">Try adjusting your search or filter criteria.</p>
            </div>
          `;
          return;
        }

        sortedAPIs.forEach(api => this.createAPICard(api, container));
      }

      createAPICard(api, container) {
        const card = document.getElementById('api-card-template').content.cloneNode(true);
        const latencyInfo = this.getLatencyCategory(api.latency);
        const uptime = this.calculateUptime(api.name);

        // Basic info
        card.querySelector('h3').textContent = api.name;
        card.querySelector('.api-url').textContent = api.url;

        // Status indicator and badge
        const statusIndicator = card.querySelector('.status-indicator');
        const statusBadge = card.querySelector('.status-badge');

        if (api.status === 'UP') {
          statusIndicator.className = 'status-indicator status-up';
          statusBadge.className = 'status-badge px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white';
          statusBadge.textContent = latencyInfo.category;
        } else {
          statusIndicator.className = 'status-indicator status-down';
          statusBadge.className = 'status-badge px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white';
          statusBadge.textContent = 'DOWN';
        }

        // Critical tag
        if (api.critical) {
          card.querySelector('.critical-tag').classList.remove('hidden');
          card.querySelector('.api-card').classList.add('critical-glow');
        }

        // Details
        card.querySelector('.status-text').textContent = api.status;
        card.querySelector('.code-text').textContent = api.code || '--';
        const displayLatency = api.latency && api.latency > 0 ? Math.max(0, api.latency) : null;
        card.querySelector('.latency-text').textContent = displayLatency ? `${displayLatency}ms` : '--';
        card.querySelector('.time-text').textContent = new Date(api.timestamp).toLocaleTimeString();

        // Latency bar
        const latencyProgress = card.querySelector('.latency-progress');
        if (displayLatency) {
          const percentage = Math.min(100, (displayLatency / 2000) * 100);
          latencyProgress.style.width = `${percentage}%`;
          latencyProgress.style.background = `linear-gradient(90deg, ${latencyInfo.color}, ${latencyInfo.color}dd)`;
        }

        card.querySelector('.latency-category').textContent = latencyInfo.category;

        // Uptime chart
        this.renderUptimeChart(card, api.name);
        card.querySelector('.uptime-percentage').textContent = `${uptime}%`;

        // History
        this.renderHistory(card, api.name);

        // Toggle history
        const toggleBtn = card.querySelector('.toggle-history');
        const historyContainer = card.querySelector('.history-container');

        toggleBtn.addEventListener('click', (e) => {
          e.stopPropagation();

          // Close other history panels
          document.querySelectorAll('.history-container').forEach(container => {
            if (container !== historyContainer) {
              container.classList.add('hidden');
              const otherToggle = container.closest('.api-card').querySelector('.toggle-history');
              otherToggle.innerHTML = '<i class="fas fa-chevron-down"></i><span>Show History</span>';
            }
          });

          // Toggle current panel
          const isHidden = historyContainer.classList.contains('hidden');
          historyContainer.classList.toggle('hidden');
          toggleBtn.innerHTML = isHidden
            ? '<i class="fas fa-chevron-up"></i><span>Hide History</span>'
            : '<i class="fas fa-chevron-down"></i><span>Show History</span>';
        });

        container.appendChild(card);
      }

      renderUptimeChart(card, apiName) {
        const chartContainer = card.querySelector('.uptime-chart');
        const apiHistory = this.history.filter(item => item.name === apiName).slice(-24);

        chartContainer.innerHTML = '';

        if (apiHistory.length === 0) {
          chartContainer.innerHTML = '<div class="text-xs text-gray-500 text-center">No data</div>';
          return;
        }

        apiHistory.forEach(item => {
          const bar = document.createElement('div');
          bar.className = 'uptime-bar';

          if (item.status === 'UP') {
            if (item.latency > 1000) bar.classList.add('moderate');
            else bar.classList.add('up');
          } else {
            bar.classList.add('down');
          }

          bar.title = `${new Date(item.timestamp).toLocaleTimeString()}: ${item.status} (${item.latency || '--'}ms)`;
          chartContainer.appendChild(bar);
        });
      }

      renderHistory(card, apiName) {
        const historyContainer = card.querySelector('.history-timeline');
        const apiHistory = this.history.filter(item => item.name === apiName).slice(-10);

        historyContainer.innerHTML = '';

        apiHistory.reverse().forEach(item => {
          const historyItem = document.createElement('div');
          let statusClass = item.status.toLowerCase();

          if (item.status === 'UP' && item.latency > 1000) {
            statusClass = 'moderate';
          }

          historyItem.className = `history-item ${statusClass}`;
          historyItem.innerHTML = `
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs font-medium">${new Date(item.timestamp).toLocaleTimeString()}</span>
              <span class="text-xs px-2 py-1 rounded-full ${item.status === 'UP' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${item.status}</span>
            </div>
            <div class="flex justify-between text-xs text-gray-400">
              <span>${item.latency ? item.latency + 'ms' : '--'}</span>
              <span>HTTP ${item.code || '--'}</span>
            </div>
          `;

          historyContainer.appendChild(historyItem);
        });
      }

      // Location Testing Methods
      openLocationTestModal() {
        const modal = document.getElementById('location-test-modal');
        modal.classList.remove('hidden');

        // Store original body overflow and prevent background scrolling
        this.originalBodyOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';

        // Update API count
        document.getElementById('total-apis-count').textContent = this.apis.length;

        // Initialize results table
        this.initializeLocationTestTable();
      }

      closeLocationTestModal() {
        const modal = document.getElementById('location-test-modal');
        modal.classList.add('hidden');

        // Restore original body overflow
        document.body.style.overflow = this.originalBodyOverflow || 'auto';

        // Stop any running tests
        this.stopLocationTest();
      }

      initializeLocationTestTable() {
        const tbody = document.getElementById('location-test-results');
        const mobileResults = document.getElementById('mobile-test-results');
        tbody.innerHTML = '';
        mobileResults.innerHTML = '';

        this.apis.forEach(api => {
          const safeId = api.name.replace(/[^a-zA-Z0-9]/g, '');

          // Desktop table row
          const row = document.createElement('tr');
          row.className = 'border-b border-gray-800 hover:bg-gray-900/30 transition-colors';
          row.innerHTML = `
            <td class="px-2 sm:px-3 lg:px-4 py-3">
              <div class="font-medium text-white text-xs sm:text-sm lg:text-base">${api.name}</div>
              <div class="text-xs text-gray-400 truncate max-w-[120px] sm:max-w-[150px] lg:max-w-[200px]">${api.url}</div>
            </td>
            <td class="px-2 sm:px-3 lg:px-4 py-3">
              <div class="flex items-center gap-1 sm:gap-2">
                <span class="status-badge px-1.5 sm:px-2 py-1 rounded-full text-xs font-bold ${api.status === 'UP' ? 'bg-green-500' : 'bg-red-500'} text-white">
                  ${api.status}
                </span>
                <span class="text-xs sm:text-sm text-gray-300">${api.latency ? api.latency + 'ms' : '--'}</span>
              </div>
            </td>
            <td class="px-2 sm:px-3 lg:px-4 py-3" id="user-result-${safeId}">
              <span class="text-gray-400 text-xs sm:text-sm">Not tested</span>
            </td>
            <td class="px-2 sm:px-3 lg:px-4 py-3 hidden lg:table-cell" id="test-method-${safeId}">
              <span class="text-gray-400 text-xs sm:text-sm">--</span>
            </td>
            <td class="px-2 sm:px-3 lg:px-4 py-3 hidden xl:table-cell" id="latency-diff-${safeId}">
              <span class="text-gray-400 text-xs sm:text-sm">--</span>
            </td>
          `;
          tbody.appendChild(row);

          // Mobile card
          const mobileCard = document.createElement('div');
          mobileCard.className = 'mobile-card';
          mobileCard.innerHTML = `
            <div class="flex justify-between items-start mb-3">
              <div class="flex-1 min-w-0">
                <h3 class="font-medium text-white text-sm sm:text-base mb-1">${api.name}</h3>
                <p class="text-xs sm:text-sm text-gray-400 truncate">${api.url}</p>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs sm:text-sm">
              <div class="space-y-2">
                <div>
                  <span class="text-gray-500 font-medium">Server:</span>
                  <div class="flex items-center gap-1 mt-1">
                    <span class="status-badge px-2 py-1 rounded-full text-xs font-bold ${api.status === 'UP' ? 'bg-green-500' : 'bg-red-500'} text-white">
                      ${api.status}
                    </span>
                    <span class="text-gray-300">${api.latency ? api.latency + 'ms' : '--'}</span>
                  </div>
                </div>

                <div>
                  <span class="text-gray-500 font-medium">Your Location:</span>
                  <div class="mt-1" id="mobile-user-result-${safeId}">
                    <span class="text-gray-400">Not tested</span>
                  </div>
                </div>
              </div>

              <div class="space-y-2">
                <div>
                  <span class="text-gray-500 font-medium">Method:</span>
                  <div class="mt-1" id="mobile-test-method-${safeId}">
                    <span class="text-gray-400">--</span>
                  </div>
                </div>

                <div id="mobile-latency-diff-${safeId}">
                  <span class="text-gray-500 font-medium">Latency Diff:</span>
                  <div class="mt-1">
                    <span class="text-gray-400">--</span>
                  </div>
                </div>
              </div>
            </div>
          `;
          mobileResults.appendChild(mobileCard);
        });
      }

      async startLocationTest() {
        this.isLocationTesting = true;
        const startBtn = document.getElementById('start-location-test');
        const stopBtn = document.getElementById('stop-location-test');
        const progressSpan = document.getElementById('test-progress');

        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');

        // Lambda proxy URL (Mumbai region for Indian users)
        this.lambdaProxyUrl = 'https://gbyqtlkyraiyuz4w6iwsvckvmm0ocakj.lambda-url.ap-south-1.on.aws/';

        let completed = 0;

        for (const api of this.apis) {
          if (!this.isLocationTesting) break;

          completed++;
          progressSpan.textContent = `Testing ${completed} of ${this.apis.length} APIs...`;

          const safeId = api.name.replace(/[^a-zA-Z0-9]/g, '');
          const userResultCell = document.getElementById(`user-result-${safeId}`);
          const testMethodCell = document.getElementById(`test-method-${safeId}`);
          const latencyDiffCell = document.getElementById(`latency-diff-${safeId}`);

          // Show testing indicator
          userResultCell.innerHTML = '<span class="text-blue-400 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i>Testing...</span>';

          try {
            const result = await this.testApiFromLocation(api);
            this.updateLocationTestResult(safeId, api, result);
          } catch (error) {
            console.error(`Error testing ${api.name}:`, error);
            userResultCell.innerHTML = '<span class="text-red-400 text-sm">Test failed</span>';
            testMethodCell.innerHTML = '<span class="text-gray-400 text-sm">Error</span>';
          }

          // Small delay between tests to avoid overwhelming
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        if (this.isLocationTesting) {
          progressSpan.textContent = `Completed testing ${this.apis.length} APIs`;
        }

        this.stopLocationTest();
      }

      stopLocationTest() {
        this.isLocationTesting = false;
        const startBtn = document.getElementById('start-location-test');
        const stopBtn = document.getElementById('stop-location-test');

        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
      }

      async testApiFromLocation(api) {
        const startTime = performance.now();

        try {
          // First attempt: Direct browser request
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);

          const response = await fetch(api.url, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-store',
            signal: controller.signal,
            headers: {
              'Accept': 'application/json, text/plain, */*'
            }
          });

          clearTimeout(timeoutId);
          const endTime = performance.now();
          const latency = Math.round(endTime - startTime);

          return {
            success: true,
            status: response.status,
            latency,
            method: 'Direct from your browser',
            error: null
          };

        } catch (error) {
          // If direct request fails (likely CORS), try Lambda proxy
          if (error.name === 'TypeError' || error.message.includes('CORS') || error.message.includes('fetch')) {
            return await this.testApiViaProxy(api, startTime);
          }

          const endTime = performance.now();
          const latency = Math.round(endTime - startTime);

          return {
            success: false,
            status: null,
            latency,
            method: 'Direct from your browser',
            error: error.message
          };
        }
      }

      async testApiViaProxy(api, originalStartTime) {
        try {
          const proxyStartTime = performance.now();
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          const response = await fetch(this.lambdaProxyUrl, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-store',
            signal: controller.signal,
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              url: api.url,
              method: 'GET',
              timeout: 10
            })
          });

          clearTimeout(timeoutId);
          const endTime = performance.now();
          const totalLatency = Math.round(endTime - originalStartTime);

          if (!response.ok) {
            throw new Error(`Proxy error: ${response.status}`);
          }

          const result = await response.json();

          return {
            success: result.success,
            status: result.status_code,
            latency: result.latency_ms, // Use the Lambda's measured latency
            method: 'Via CORS proxy (Lambda)',
            error: result.error
          };

        } catch (error) {
          const endTime = performance.now();
          const latency = Math.round(endTime - originalStartTime);

          return {
            success: false,
            status: null,
            latency,
            method: 'CORS blocked entirely',
            error: error.message
          };
        }
      }

      updateLocationTestResult(safeId, api, result) {
        // Update desktop table
        const userResultCell = document.getElementById(`user-result-${safeId}`);
        const testMethodCell = document.getElementById(`test-method-${safeId}`);
        const latencyDiffCell = document.getElementById(`latency-diff-${safeId}`);

        // Update mobile cards
        const mobileUserResult = document.getElementById(`mobile-user-result-${safeId}`);
        const mobileTestMethod = document.getElementById(`mobile-test-method-${safeId}`);
        const mobileLatencyDiff = document.getElementById(`mobile-latency-diff-${safeId}`);

        const resultHtml = result.success ? `
          <div class="flex items-center gap-2">
            <span class="status-badge px-2 py-1 rounded-full text-xs font-bold bg-green-500 text-white">UP</span>
            <span class="text-sm text-gray-300">${result.latency}ms</span>
          </div>
        ` : `
          <div class="flex items-center gap-2">
            <span class="status-badge px-2 py-1 rounded-full text-xs font-bold bg-red-500 text-white">DOWN</span>
            <span class="text-sm text-gray-300">${result.latency}ms</span>
          </div>
        `;

        const mobileResultHtml = result.success ? `
          <div class="flex items-center gap-1">
            <span class="status-badge px-2 py-1 rounded-full text-xs font-bold bg-green-500 text-white">UP</span>
            <span class="text-xs text-gray-300">${result.latency}ms</span>
          </div>
        ` : `
          <div class="flex items-center gap-1">
            <span class="status-badge px-2 py-1 rounded-full text-xs font-bold bg-red-500 text-white">DOWN</span>
            <span class="text-xs text-gray-300">${result.latency}ms</span>
          </div>
        `;

        userResultCell.innerHTML = resultHtml;
        mobileUserResult.innerHTML = mobileResultHtml;

        // Update test method
        let methodColor = 'text-blue-400';
        if (result.method === 'Via CORS proxy (Lambda)') {
          methodColor = 'text-yellow-400';
        } else if (result.method === 'CORS blocked entirely') {
          methodColor = 'text-red-400';
        }

        if (testMethodCell) testMethodCell.innerHTML = `<span class="${methodColor} text-sm">${result.method}</span>`;
        mobileTestMethod.innerHTML = `<span class="${methodColor} text-xs">${result.method}</span>`;

        // Calculate and display latency difference
        if (api.latency && result.latency) {
          const diff = result.latency - api.latency;
          const diffText = diff > 0 ? `+${diff}ms` : `${diff}ms`;
          const diffColor = Math.abs(diff) < 100 ? 'text-green-400' : (diff > 0 ? 'text-red-400' : 'text-blue-400');

          if (latencyDiffCell) latencyDiffCell.innerHTML = `<span class="${diffColor} text-sm font-mono">${diffText}</span>`;
          mobileLatencyDiff.querySelector('div').innerHTML = `<span class="${diffColor} text-xs font-mono">${diffText}</span>`;
        } else {
          if (latencyDiffCell) latencyDiffCell.innerHTML = '<span class="text-gray-400 text-sm">--</span>';
          mobileLatencyDiff.querySelector('div').innerHTML = '<span class="text-gray-400 text-xs">--</span>';
        }
      }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      window.apiMonitor = new APIMonitor();
    });
  </script>
</body>
</html>